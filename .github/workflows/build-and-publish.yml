name: Build and Publish Dataset

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Dataset version (e.g., v1.0.0)'
        required: true
        type: string
      upload_to_hf:
        description: 'Upload to HuggingFace'
        required: true
        type: boolean
    default: false

permissions:
  contents: write

env:
  DATASET_NAME: unified-tag-database
  HF_REPO: NEXTAltair/unified-tag-database
  HF_REPO_CC0: NEXTAltair/genai-image-tag-db
  HF_REPO_MIT: NEXTAltair/genai-image-tag-db-mit
  HF_REPO_CC4: NEXTAltair/genai-image-tag-db-CC4

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv sync --dev

      - name: Run CI orchestrator (build CC0 -> MIT/CC4)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.upload_to_hf }}" = "true" ]; then
            PUBLISH_FLAG="--publish"
          else
            PUBLISH_FLAG=""
          fi
          uv run python -m builder_ci.main \
            --target all \
            --sources-yml builder_ci/sources.yml \
            --sources-dir . \
            --output-root ci_output \
            --external-sources-dir external_sources \
            --base-db-dir base_dbs/cc0 \
            --base-cc0-repo "${HF_REPO_CC0}" \
            --repo-cc0 "${HF_REPO_CC0}" \
            --repo-mit "${HF_REPO_MIT}" \
            --repo-cc4 "${HF_REPO_CC4}" \
            --version "${{ github.event.inputs.version }}" \
            ${PUBLISH_FLAG} \
            ${FORCE_FLAG}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tag-database-${{ github.event.inputs.version }}
          path: |
            ci_output/out_db_cc0/genai-image-tag-db-cc0.sqlite
            ci_output/out_db_cc0/build_manifest.json
            ci_output/out_db_cc0/README.md
            ci_output/out_db_cc0/parquet_danbooru
            ci_output/out_db_cc0/report
            ci_output/out_db_mit/genai-image-tag-db-mit.sqlite
            ci_output/out_db_mit/build_manifest.json
            ci_output/out_db_mit/README.md
            ci_output/out_db_mit/parquet_danbooru
            ci_output/out_db_mit/report
            ci_output/out_db_cc4/genai-image-tag-db-cc4.sqlite
            ci_output/out_db_cc4/build_manifest.json
            ci_output/out_db_cc4/README.md
            ci_output/out_db_cc4/parquet_danbooru
            ci_output/out_db_cc4/report
          retention-days: 30
